# cluster_init.yaml
---
- name: k8 cluster control plane init
  become: true
  become_user: root
  vars:
    cp_host: "k8smaster"
    wk_host: "k8sworker1"
  tags:
    - init
  block:
    - name: Initialize the control plane
      ansible.builtin.shell:
        cmd: "kubeadm init --apiserver-advertise-address 192.168.65.40 --control-plane-endpoint 192.168.65.40 | tee kubeadm-init.out"
      delegate_to: "{{ cp_host }}"
      when: "cp_host in inventory_hostname"
      changed_when: false

  rescue:
    - name: Handle errors during cp init
      ansible.builtin.debug:
        msg: ":: CP INIT ERROR ::"


    - name: Print found ipv4
      ansible.builtin.debug:
        msg: "Control plane IP: {{ cp_ip }}"
      delegate_to: "{{ cp_host }}"
      when: "cp_host in inventory_hostname"

    - name: Add local DNS alias to cluster
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ cp_ip }}  master"
        insertbefore: '^(127\.0\.0\.1|localhost)'
        state: present
        regexp: '^{{ cp_ip }}\s{2}k8smaster$'